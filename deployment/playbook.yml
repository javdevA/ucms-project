---
- name: Deploy UCMS Production Environment
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - name: Build UCMS Docker image
      shell: docker build -t ucms-app .
      args:
        chdir: "{{ playbook_dir }}/../"
        creates: "{{ playbook_dir }}/../ucms-app.tar"

    - name: Stop existing containers
      shell: docker-compose down || true
      args:
        chdir: "{{ playbook_dir }}/../"

    - name: Start UCMS stack
      shell: docker-compose up -d
      args:
        chdir: "{{ playbook_dir }}/../"

    - name: Wait for API
      wait_for:
        port: 8000
        host: localhost
        delay: 5
        timeout: 30

    - name: Test API endpoint
      uri:
        url: http://localhost:8000
        method: GET
        status_code: 200
      register: result

    - name: Show success
      debug:
        msg: "ðŸŽ‰ UCMS DEPLOYED SUCCESSFULLY! API Status: {{ result.status }} - Visit http://localhost:8000/docs"

